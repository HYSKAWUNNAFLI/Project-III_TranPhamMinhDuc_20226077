{
  "info": {
    "name": "AIMS Auth & RBAC Tests",
    "_postman_id": "b7d7a3c1-1c2b-4c9a-9f5e-aims-auth-tests",
    "schema": "https://schema.postman.com/collection/json/v2.1.0/collection.json",
    "description": "Authentication, refresh, logout, RBAC, and password change test suite for AIMS."
  },
  "variable": [{ "key": "baseUrl", "value": "http://localhost:8080" }],
  "item": [
    {
      "name": "1. Registration",
      "item": [
        {
          "name": "1. Register Customer",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"customer@test.com\",\n  \"password\": \"password123\",\n  \"roles\": [\"ROLE_CUSTOMER\"]\n}"
            },
            "url": "{{baseUrl}}/auth/register"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Customer created successfully', function () {",
                  "  var jsonData = pm.response.json();",
                  "  pm.expect(jsonData.data).to.have.property('id');",
                  "  pm.expect(jsonData.data.email).to.eql('customer@test.com');",
                  "  pm.expect(jsonData.data.status).to.eql('ACTIVE');",
                  "  pm.expect(jsonData.data.roles).to.include('ROLE_CUSTOMER');",
                  "  pm.environment.set('customerId', jsonData.data.id);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "2. Register Product Manager",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"manager@test.com\",\n  \"password\": \"manager123\",\n  \"roles\": [\"ROLE_PRODUCT_MANAGER\"]\n}"
            },
            "url": "{{baseUrl}}/auth/register"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Manager created successfully', function () {",
                  "  var jsonData = pm.response.json();",
                  "  pm.expect(jsonData.data).to.have.property('id');",
                  "  pm.expect(jsonData.data.email).to.eql('manager@test.com');",
                  "  pm.expect(jsonData.data.status).to.eql('ACTIVE');",
                  "  pm.expect(jsonData.data.roles).to.include('ROLE_PRODUCT_MANAGER');",
                  "  pm.environment.set('managerId', jsonData.data.id);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "3. Register Admin",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"newadmin@test.com\",\n  \"password\": \"admin123456\",\n  \"roles\": [\"ROLE_ADMIN\"]\n}"
            },
            "url": "{{baseUrl}}/auth/register"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Admin created successfully', function () {",
                  "  var jsonData = pm.response.json();",
                  "  pm.expect(jsonData.data).to.have.property('id');",
                  "  pm.expect(jsonData.data.email).to.eql('newadmin@test.com');",
                  "  pm.expect(jsonData.data.status).to.eql('ACTIVE');",
                  "  pm.expect(jsonData.data.roles).to.include('ROLE_ADMIN');",
                  "  pm.environment.set('newAdminId', jsonData.data.id);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "4. Register Duplicate Email (Fail)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"admin@aims.com\",\n  \"password\": \"password123\"\n}"
            },
            "url": "{{baseUrl}}/auth/register"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Duplicate email rejected', function () {",
                  "  pm.response.to.have.status(400);",
                  "  var jsonData = pm.response.json();",
                  "  pm.expect(jsonData.message || '').to.include('Email');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "5. Register Invalid Email (Fail)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"not-an-email\",\n  \"password\": \"password123\"\n}"
            },
            "url": "{{baseUrl}}/auth/register"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Invalid email rejected', function () {",
                  "  pm.response.to.have.status(400);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "6. Register Short Password (Fail)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"shortpass@test.com\",\n  \"password\": \"12345\"\n}"
            },
            "url": "{{baseUrl}}/auth/register"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Short password rejected', function () {",
                  "  pm.response.to.have.status(400);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "7. Register Invalid Role (Fail)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"badrole@test.com\",\n  \"password\": \"password123\",\n  \"roles\": [\"ROLE_INVALID\"]\n}"
            },
            "url": "{{baseUrl}}/auth/register"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Invalid role rejected', function () {",
                  "  pm.response.to.have.status(400);",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "2. Login",
      "item": [
        {
          "name": "8. Login as Admin (Default)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"admin@aims.com\",\n  \"password\": \"admin123\"\n}"
            },
            "url": "{{baseUrl}}/auth/login"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Login successful', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Save admin access token', function () {",
                  "  var jsonData = pm.response.json();",
                  "  pm.expect(jsonData.data).to.have.property('accessToken');",
                  "  pm.environment.set('adminAccessToken', jsonData.data.accessToken);",
                  "  pm.environment.set('accessToken', jsonData.data.accessToken);",
                  "  if (jsonData.data.user && jsonData.data.user.id) {",
                  "    pm.environment.set('adminId', jsonData.data.user.id);",
                  "    pm.environment.set('userId', jsonData.data.user.id);",
                  "  }",
                  "});",
                  "",
                  "pm.test('Refresh token cookie may be set', function () {",
                  "  pm.expect(true).to.be.true;",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "9. Login as Customer",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"customer@test.com\",\n  \"password\": \"password123\"\n}"
            },
            "url": "{{baseUrl}}/auth/login"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Customer login successful', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Save customer access token', function () {",
                  "  var jsonData = pm.response.json();",
                  "  pm.environment.set('customerAccessToken', jsonData.data.accessToken);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "10. Login as Product Manager",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"manager@test.com\",\n  \"password\": \"manager123\"\n}"
            },
            "url": "{{baseUrl}}/auth/login"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Manager login successful', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Save manager access token', function () {",
                  "  var jsonData = pm.response.json();",
                  "  pm.environment.set('managerAccessToken', jsonData.data.accessToken);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "11. Login Wrong Password (Fail)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"admin@aims.com\",\n  \"password\": \"wrongpassword\"\n}"
            },
            "url": "{{baseUrl}}/auth/login"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Invalid credentials rejected', function () {",
                  "  pm.response.to.have.status(400);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "12. Login Non-existent User (Fail)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"nonexistent@test.com\",\n  \"password\": \"password123\"\n}"
            },
            "url": "{{baseUrl}}/auth/login"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Non-existent user rejected', function () {",
                  "  pm.response.to.have.status(400);",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "3. Token Refresh & Logout",
      "item": [
        {
          "name": "13. Refresh Access Token",
          "request": {
            "method": "POST",
            "url": "{{baseUrl}}/auth/refresh"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Token refreshed successfully', function () {",
                  "  pm.response.to.have.status(200);",
                  "  var jsonData = pm.response.json();",
                  "  pm.expect(jsonData.data).to.have.property('accessToken');",
                  "  pm.environment.set('accessToken', jsonData.data.accessToken);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "14. Refresh Without Cookie (Fail)",
          "request": {
            "method": "POST",
            "header": [{ "key": "X-Dummy-No-Cookie", "value": "true" }],
            "url": "{{baseUrl}}/auth/refresh"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// If you want strict behavior, run this request in an isolated runner without cookies.",
                  "pm.test('Refresh without cookie should fail', function () {",
                  "  pm.expect([400,401]).to.include(pm.response.code);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "15. Logout",
          "request": {
            "method": "POST",
            "url": "{{baseUrl}}/auth/logout"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Logout successful', function () {",
                  "  pm.response.to.have.status(200);",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "4. Protected Endpoints (RBAC)",
      "item": [
        {
          "name": "16. Access Admin Users with Admin Token",
          "request": {
            "method": "GET",
            "header": [
              { "key": "Authorization", "value": "Bearer {{adminAccessToken}}" }
            ],
            "url": "{{baseUrl}}/admin/users"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Admin access allowed', function () {",
                  "  pm.response.to.have.status(200);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "17. Access Admin Users Without Token (Fail)",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}/admin/users"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Missing token rejected', function () {",
                  "  pm.response.to.have.status(401);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "18. Access Admin Users as Customer (Fail)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{customerAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/admin/users"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Customer forbidden', function () {",
                  "  pm.response.to.have.status(403);",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "5. Password Change",
      "item": [
        {
          "name": "19. Change Password (Admin)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/json" },
              { "key": "Authorization", "value": "Bearer {{adminAccessToken}}" }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"oldPassword\": \"admin123\",\n  \"newPassword\": \"newpassword123\"\n}"
            },
            "url": "{{baseUrl}}/auth/change-password?userId={{adminId}}"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Password updated', function () {",
                  "  pm.response.to.have.status(200);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "20. Login with New Password",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"admin@aims.com\",\n  \"password\": \"newpassword123\"\n}"
            },
            "url": "{{baseUrl}}/auth/login"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Login with new password succeeds', function () {",
                  "  pm.response.to.have.status(200);",
                  "  var jsonData = pm.response.json();",
                  "  pm.environment.set('adminAccessToken', jsonData.data.accessToken);",
                  "  pm.environment.set('accessToken', jsonData.data.accessToken);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "21. Login with Old Password (Fail)",
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"admin@aims.com\",\n  \"password\": \"admin123\"\n}"
            },
            "url": "{{baseUrl}}/auth/login"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Old password rejected', function () {",
                  "  pm.response.to.have.status(400);",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    }
  ]
}
